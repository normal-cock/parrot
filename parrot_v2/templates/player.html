<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Video.js Audio Player Demo</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
    <link href="https://cdn.staticfile.org/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.staticfile.org/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <!-- <script
        src="https://cdn.jsdelivr.net/npm/videojs-landscape-fullscreen@1.4.6/dist/videojs-landscape-fullscreen.min.js"></script> -->

    <!-- City -->
    <link href="https://unpkg.com/@videojs/themes@1/dist/city/index.css" rel="stylesheet">

    <style>
        body {
            width: auto;
            margin: auto;
            max-width: 1200px;
            height: 80vh;
        }

        .container-fluid {
            padding-left: 0;
            padding-right: 0;
        }

        #audioPlayer {
            width: 100%;
            height: 15vh;
        }

        /* .custom-tool {
            height: 15vh;
        } */


        #subtitle-list {
            height: 65vh;
            width: auto;
            overflow: auto;
            margin: 5%;
            font-size: 1.5em;
        }

        .list-group-item {
            /* 设置内填充为 10 像素 */
            padding: 3%;
            border: none;
        }

        .list-group-item-subcue {
            font-size: 0.7em;
        }

        .form-check-label {
            font-size: 1.5em;
        }

        .video-js {
            width: 100vw;
        }

        @media only screen and (hover: none) and (pointer: coarse) {

            /* 样式 */
            #subtitle-list {
                font-size: 3rem;
            }
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div data-vjs-player="true">
            <video id="audioPlayer" class="vjs-fluid video-js vjs-theme-city" controls preload="metadata" width="100%"
                data-setup='{}' crossorigin="anonymous">
                <p class="vjs-no-js">
                    您的浏览器不支持 HTML5 视频播放器，请升级浏览器。
                </p>
                <source src="{{ audio_url }}" type="audio/mp3">
                <track label="English" kind="metadata" srclang="en" src="{{ subtitle_url }}" default>
                </track>
                {% if subtitle_url_2|length != 0 %}
                <track label="Chinese" kind="metadata" srclang="cn" src="{{ subtitle_url_2 }}" default>
                </track>
                {% endif %}
            </video>
        </div>
    </div>
    <div class="custom-area">
        <div class="custom-tool">
            <div class="btn-group" role="group" aria-label="Media Player Control Buttons">
                <button type="button" class="btn btn-default" onclick="previousAudio();">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="32" fill="currentColor"
                        class="bi bi-skip-start-fill" viewBox="0 0 16 16">
                        <path
                            d="M4 4a.5.5 0 0 1 1 0v3.248l6.267-3.636c.54-.313 1.232.066 1.232.696v7.384c0 .63-.692 1.01-1.232.697L5 8.753V12a.5.5 0 0 1-1 0z" />
                    </svg>
                </button>
                <button type="button" class="btn btn-default" onclick="nextAudio();">
                    <!-- <span class="glyphicon glyphicon-step-forward"></span> -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="32" fill="currentColor"
                        class="bi bi-skip-end-fill" viewBox="0 0 16 16">
                        <path
                            d="M12.5 4a.5.5 0 0 0-1 0v3.248L5.233 3.612C4.693 3.3 4 3.678 4 4.308v7.384c0 .63.692 1.01 1.233.697L11.5 8.753V12a.5.5 0 0 0 1 0z" />
                    </svg>
                </button>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="singleLineLoop" checked="true">
                    <label class="form-check-label" for="singleLineLoop">单行循环</label>
                    </input>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="audioOnlyMode" checked="true">
                    <label class="form-check-label" for="audioOnlyMode">音频模式</label>
                    </input>
                </div>
                <div id="app" class="form-check">
                    <input type="number" id="duration" name="duration" min="-5" max="5" step="0.01" value="0">
                </div>
            </div>
        </div>
        <div>
            <ul id="subtitle-list" class="list-group"></ul>
        </div>
    </div>

    <script>
        const audioSrc = '{{ audio_url }}';
        const videoSrc = '{{ video_url }}';
        const subtitleSrc = '{ { subtitle_url } }';
        var adjustTime = {{ adjust_time }};
        const localCurIndexKey = 'parrot:{{ item_id }}:local_cur_index';
        const adjustTimeKey = 'parrot:{{ item_id }}:local_adjust_time';
        const initOptions = {
            // crossorigin: 'anonymous',
            audioOnlyMode: true,
            preload: 'metadata',
            // src: audioSrc,
            // sources: {
            //     type: 'audio/mp3', src: audioSrc
            // },
            controlBar: {
                remainingTimeDisplay: {
                    displayNegative: false
                }
            },
            responsive: true,
            techOrder: ["html5", "flash", "youtube"],
            autoplay: false, controls: true, mute: false, playsinline: true,
        };

        // https://videojs.com/guides/options/
        // videojs.getPlayer('audioPlayer').ready(
        videojs('audioPlayer', null, function () {
            // getPlayer may return null if player is not ready
            const audioPlayer = videojs.getPlayer('audioPlayer');
            audioPlayer.options(initOptions);
            // audioPlayer.addRemoteTextTrack({
            //     src: subtitleSrc,
            //     label: "English",
            //     kind: "metadata",
            //     srclang: "en",
            //     default: true,
            // });

            $('#duration').on('input', function () {
                adjustTime = parseFloat($(this).val()); // 更新 javascript 变量 myVar
                storeLocalCurIndex();
            });

            function findENCues() {
                return Array.from(audioPlayer.textTracks()).find(track => track.language === 'en');
            }
            function findCNCues() {
                return Array.from(audioPlayer.textTracks()).find(track => track.language === 'cn');
            }

            function findProperCueIndex(currentTime) {
                const cues = Array.from(findENCues()?.cues || []);

                //为每个cue分配一个唯一的ID
                if (cues.length <= 1) {
                    return 0;
                }
                for (var i = 0; i < cues.length; i++) {
                    var cue = cues[i];
                    if (currentTime <= cue.endTime) {
                        return i;
                    }
                }
                return cues.length - 1;
            }
            function getCuesLength() {
                return Array.from(findENCues()?.cues || []).length;
            }
            function getSubCuesLength() {
                return Array.from(findCNCues()?.cues || []).length;
            }

            function fetchLocalCurIndex() {
                const curIndexValue = localStorage.getItem(localCurIndexKey);
                if (curIndexValue == null) {
                    audioPlayer.currentCueIndex = 0
                } else {
                    audioPlayer.currentCueIndex = parseInt(curIndexValue);
                }
                const tmpAdjustTime = localStorage.getItem(adjustTimeKey);
                if (tmpAdjustTime != null) {
                    adjustTime = parseFloat(tmpAdjustTime);
                    $('#duration').val(adjustTime);
                }
            }

            function storeLocalCurIndex() {
                console.log('storeLocalCurIndex||audioPlayer.currentCueIndex:' + audioPlayer.currentCueIndex)
                localStorage.setItem(localCurIndexKey, audioPlayer.currentCueIndex);
                localStorage.setItem(adjustTimeKey, adjustTime);
            }

            function jump2CurCue() {
                // https://docs.videojs.com/docs/api/player.html#MethodsreadyState
                if (audioPlayer.readyState() < 1) {
                    return
                }
                console.log('jump2CurCue||audioPlayer.currentCueIndex:' + audioPlayer.currentCueIndex)
                var cue = findENCues()?.cues[audioPlayer.currentCueIndex];
                audioPlayer.currentTime(cue.startTime + adjustTime);
                // only improve ending time exceedence, couldn't solve it completely
                setTimeout(timeUpdate, cue.endTime - cue.startTime - 0.1)
                setTimeout(timeUpdate, cue.endTime - cue.startTime)
                setTimeout(timeUpdate, cue.endTime - cue.startTime + 0.1)

                storeLocalCurIndex();
            }

            function timeUpdate() {
                // https://docs.videojs.com/docs/api/player.html#MethodsreadyState
                if (audioPlayer.readyState() < 1) {
                    return
                }
                console.log('timeUpdate||currentTime:' + audioPlayer.currentTime());

                const currentTime = audioPlayer.currentTime();
                const cues = Array.from(findENCues()?.cues || []);
                if (audioPlayer.currentCueIndex >= 0 && audioPlayer.currentCueIndex < cues.length) {
                    var cue = cues[audioPlayer.currentCueIndex];
                    // for more graceful ending
                    const cueStarttime = cue.startTime + adjustTime - 0.01;
                    const cueEndtime = cue.endTime + adjustTime;
                    // Only when the end of a piece or progress bar operation
                    // We can't distinguish between progress bar change and timeupdate
                    // because currentTime change will also trigger seeking and seeked event.
                    // So here we differentiate them through duration between new_current_time 
                    // and cues[audioPlayer.currentCueIndex].endTime, if it's less than 1s, it's
                    // considered as ending of a piece, otherwise a manual progress bar operation
                    // because most of the time, mannual progess bar operation aimed at big
                    // time change
                    if (!(cueStarttime <= currentTime && currentTime < cueEndtime)) {
                        // adjust cue index proactively is not often used, so cancel this temporarily
                        if (Math.abs(currentTime - cueEndtime) > 1) {
                            // audioPlayer.currentCueIndex = findProperCueIndex(currentTime)
                        }

                        flushListHighlight();
                        // less than 0.1 is ok
                        console.log('timeUpdate||Endtime exceedance:' + (audioPlayer.currentTime() - cueEndtime));
                        jump2CurCue();
                    }
                } else (
                    audioPlayer.pause()
                )
            }

            function flushListHighlight() {
                var highlightClass = 'list-group-item-success';
                var list = $('#subtitle-list');
                list.find('li').removeClass(highlightClass);
                var li = list.children().eq(audioPlayer.currentCueIndex);
                li.addClass(highlightClass);

                var pos = (
                    li.offset().top + list.scrollTop()
                    - list.offset().top - list.height() / 2 + li.height() / 2);
                // console.log('pos:' + pos);
                list.animate({ scrollTop: pos });
            }

            function formatTime(seconds) {
                var time = new Date(0, 0, 0, 0, 0, seconds.toFixed(2));
                var hours = time.getHours().toString().padStart(2, '0');
                var minutes = time.getMinutes().toString().padStart(2, '0');
                var seconds = time.getSeconds().toString().padStart(2, '0');

                return hours + ":" + minutes + ":" + seconds;
            }

            function loadedmetadata() {
                // 获取第一个 TextTrack
                console.log('loadedmetadata||Subtitles loaded cue:' + getCuesLength());

                setTimeout(function () {
                    console.log('loadedmetadata||time trigger');
                    console.log('loadedmetadata||Subtitles loaded cue:' + getCuesLength());
                    const cues = Array.from(findENCues()?.cues || []);
                    //为每个cue分配一个唯一的ID
                    for (var i = 0; i < cues.length; i++) {
                        cues[i].id = i.toString();
                    }
                    const subCues = Array.from(findCNCues()?.cues || []);
                    var hasSubCue = false;
                    if (subCues.length != 0) {
                        console.log('loadedmetadata||Subtitles 2 loaded:' + getSubCuesLength());
                        hasSubCue = true;
                    }

                    var list = $('#subtitle-list');
                    for (var i = 0, j = 0; i < cues.length; i++) {
                        let cue = cues[i];
                        var startTime = formatTime(cue.startTime);
                        // var li = $('<li class="list-group-item">').text(startTime + '-' + cue.text);
                        var li = $('<li class="list-group-item">')
                            .append($("<span>").text(startTime + '-' + cue.text));
                        if (hasSubCue == true && j < subCues.length) {
                            let subCue = subCues[j];
                            // 应对en和cn部分字幕数量不匹配的问题
                            for (; subCue.startTime < cue.startTime;) {
                                j++;
                                if (j < subCues.length) {
                                    subCue = subCues[j];
                                } else {
                                    break;
                                }
                            }
                            if (subCue.startTime == cue.startTime) {
                                li = li.append("<br>")
                                    .append($("<span>").addClass("list-group-item-subcue").text(startTime + '-' + subCue.text));
                                j++;
                            }
                        }

                        li.click(function () {
                            const selction = document.getSelection();
                            if (selction.type != 'Range') {
                                audioPlayer.currentCueIndex = parseInt(cue.id);
                                flushListHighlight();
                                // audioPlayer.currentTime(cue.startTime);
                                jump2CurCue();
                                audioPlayer.play();
                            }
                        });
                        list.append(li);
                    }
                    fetchLocalCurIndex();
                    flushListHighlight();
                    jump2CurCue();
                }, 1000);
            }

            // audioPlayer.landscapeFullscreen({
            //     fullscreen: {
            //         enterOnRotate: true,
            //         exitOnRotate: true,
            //         alwaysInLandscapeMode: true,
            //         iOS: true,
            //     }
            // });

            if ($('#audioOnlyMode').is(':checked')) {
                audioPlayer.audioOnlyMode(true);
            }
            $('#audioOnlyMode').change(function () {
                if ($('#audioOnlyMode').is(':checked')) {
                    audioPlayer.pause();
                    audioPlayer.src({
                        src: audioSrc,
                        type: 'audio/mp3',
                    });
                    audioPlayer.audioOnlyMode(true);
                    audioPlayer.load();
                    audioPlayer.one('loadedmetadata', loadedmetadata);
                    jump2CurCue();
                    console.log('audioOnlyMode||audioPlayer.currentCueIndex:' + audioPlayer.currentCueIndex)
                } else {
                    audioPlayer.pause();
                    audioPlayer.src({
                        src: videoSrc,
                        type: 'video/mp4',
                    });
                    audioPlayer.audioOnlyMode(false);
                    audioPlayer.load();
                    audioPlayer.one('loadedmetadata', loadedmetadata);
                    jump2CurCue();
                    console.log('audioOnlyMode||audioPlayer.currentCueIndex:' + audioPlayer.currentCueIndex)
                }
            });
            fetchLocalCurIndex();

            audioPlayer.on('timeupdate', function () {
                if ($('#singleLineLoop').is(':checked')) {
                    timeUpdate();
                }
            });

            audioPlayer.on('seeking', function () {
                // console.log('seeking currentTime:' + this.currentTime());
            });
            audioPlayer.on('seeked', function () {
                // console.log('seeked currentTime:' + this.currentTime());
            });
            function previousAudio() {
                audioPlayer.currentCueIndex -= 1;
                audioPlayer.currentCueIndex %= getCuesLength();
                flushListHighlight();
                jump2CurCue();
            };
            function nextAudio() {
                audioPlayer.currentCueIndex += 1;
                audioPlayer.currentCueIndex %= getCuesLength();
                flushListHighlight();
                jump2CurCue();
            };

            window.addEventListener('keydown', function (e) {
                switch (e.keyCode) {
                    case 32: // 空格键
                        if (audioPlayer.paused()) {
                            audioPlayer.play();
                        } else {
                            audioPlayer.pause();
                        }
                        e.preventDefault();
                        break;
                    case 37: // 左箭头键
                        previousAudio();
                        e.preventDefault();
                        break;
                    case 39: // 右箭头键
                        nextAudio()
                        e.preventDefault();
                        break;
                }
            }, true);

            document.addEventListener('copy', function (e) {
                const selction = document.getSelection();
                if (selction.type == 'Range') {
                    const text_only = selction.toString();
                    const clipdata = e.clipboardData || window.clipboardData;
                    clipdata.setData('text/plain', text_only);
                    clipdata.setData('text/html', text_only);
                    e.preventDefault();
                }
            });

            navigator.mediaSession.setActionHandler('play', function () {
                audioPlayer.play();
            });
            navigator.mediaSession.setActionHandler('pause', function () {
                audioPlayer.pause();
            });
            navigator.mediaSession.setActionHandler('previoustrack', function () {
                previousAudio();
            });
            navigator.mediaSession.setActionHandler('nexttrack', function () {
                nextAudio();
            });

            audioPlayer.one('loadedmetadata', loadedmetadata);

            // flushListHighlight won't work normally if browser is switched to background
            // so it's better to invoce it every time when visibility changed
            document.addEventListener("visibilitychange", function () {
                flushListHighlight();
            });
        });

    </script>

</body>

</html>