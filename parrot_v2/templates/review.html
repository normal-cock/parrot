<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
    <meta name="generator" content="Hugo 0.88.1">
    <title>Review Page</title>

    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <script src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.2.1/jquery.min.js"></script>
    <link rel="canonical" href="https://getbootstrap.com/docs/5.1/examples/sticky-footer-navbar/">

    <link href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/bootstrap/5.1.3/css/bootstrap.min.css"
        rel="stylesheet">
    <script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/bootstrap/5.1.3/js/bootstrap.min.js"></script>
    <script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/toastr.js/2.1.4/toastr.min.js"></script>
    <link href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/toastr.js/2.1.4/toastr.min.css" rel="stylesheet">

    <style>
        body {
            width: auto;
            margin: auto;
            max-width: 600px;
            height: 100vh;
        }

        #review-body {
            margin: 10%;
            font-size: 1.3em;
            height: 90%;
        }

        .btn-primary {
            width: 100%;
            height: 10%;
            font-size: 1.2em;
            margin-top: 5%;
        }

        .form-switch {
            margin-right: 2%;
        }
    </style>
</head>

<body class="d-flex flex-column h-100">
    <div class="btn-group me-2" role="group" aria-label="First group">
        <button type="button" class="btn btn-link" onclick="window.location.href = `/{{ passport }}`">Home</button>
        <button type="button" class="btn btn-link" onclick="window.location.href = `/{{ passport }}/review-page`">Begin
            Review</button>
    </div>

    <!-- <i class="bi bi-volume-down"></i> -->

    <video id="myVideo" preload="metadata" style="width: 640px; height: 360px;display: none"></video>

    <div id="review-body"></div>

    <div id="c-toast" class="toast align-items-center" role="alert" aria-live="assertive" aria-atomic="true"
        style="display:none">
        <div class="d-flex">
            <div class="toast-body">
                Hello, world! This is a toast message.
            </div>
            <button id="c-toast-button" type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Close"></button>
        </div>
    </div>

    <script>
        const reviewBody = $('#review-body');
        const toast = $('#c-toast');
        const videoPlayer = videojs('myVideo');
        var ucmOffset = 0;
        var ucmDuration = 0;

        const playIcon = $(`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-volume-down"
            viewBox="0 0 16 16">
            <path
                d="M9 4a.5.5 0 0 0-.812-.39L5.825 5.5H3.5A.5.5 0 0 0 3 6v4a.5.5 0 0 0 .5.5h2.325l2.363 1.89A.5.5 0 0 0 9 12zM6.312 6.39 8 5.04v5.92L6.312 9.61A.5.5 0 0 0 6 9.5H4v-3h2a.5.5 0 0 0 .312-.11M12.025 8a4.5 4.5 0 0 1-1.318 3.182L10 10.475A3.5 3.5 0 0 0 11.025 8 3.5 3.5 0 0 0 10 5.525l.707-.707A4.5 4.5 0 0 1 12.025 8">
            </path>
        </svg>`);

        function goHome() {
            window.location.href = `/{{ passport }}`;
        };

        function customToast(msg) {
            const toastBody = toast.find('.toast-body');
            toastBody.text(msg);
            toast.show();
        }
        function httpErrorFunc(jqXHR, textStatus, errorThrown) {
            customToast(`${jqXHR.status}\t${errorThrown}: ${jqXHR.responseText}`);
        };

        videoPlayer.on('timeupdate', function () {
            if (videoPlayer.readyState() < 1) {
                return
            }
            const currentTime = videoPlayer.currentTime();
            if (!(
                ucmOffset <= currentTime &&
                currentTime < (ucmOffset + ucmDuration))
            ) {
                videoPlayer.currentTime(ucmOffset);
            }
        });

        function fecthCallback(response, textStatus, jqXHR) {
            var statusCode = jqXHR.status;
            if (statusCode === 204) {
                reviewBody.text('Review finished!');
            } else {
                reviewBody.empty();
                const reviewIndex = response.review_index;
                const meaningBodyDiv = $('<div></div>');
                const btn = $('<button type="button" class="btn btn-primary">Complete This Record</button>');
                btn.on('click', function () {
                    $.ajax({
                        url: `/{{ passport }}/complete-review-record/${reviewIndex}`,
                        type: 'POST',
                        success: fecthCallback,
                        error: httpErrorFunc,
                    });
                });
                const progressDiv = $(`<div></div>`).text(
                    `Progress ${response.review_index + 1}/${response.total_len}`
                );
                const wordDiv = $(`<div></div>`).text(
                    `Word: ${response.meaning.word} [${response.meaning.phonetic_symbol}]`
                )
                // meaningDiv.text(JSON.stringify(response));
                const usecaseDiv = $(`<div></div>`).text(
                    'Use Case: ' + response.meaning.use_case);
                const meaningDiv = $(`<div></div>`).text(
                    'Meaning: ' +
                    response.meaning.meaning + '\t' + response.meaning.remark);
                usecaseDiv.hide();
                meaningDiv.hide();

                const switchGroupDiv = $('<div class="input-group">');

                const playBtn = $(`<button type="button" class="btn btn-success"></button>`);
                playBtn.append(playIcon);
                playBtn.text('Play');
                const ucm = response.meaning.use_case_media;
                if (ucm != undefined) {
                    videoPlayer.src({
                        src: ucm.play_url,
                        type: 'application/x-mpegURL',
                    });
                    ucmOffset = ucm.offset;
                    ucmDuration = ucm.duration;

                    playBtn.on('click', function () {
                        if (videoPlayer.paused()) {
                            videoPlayer.play();
                        } else {
                            videoPlayer.pause();
                        }
                    });
                    switchGroupDiv.append(playBtn);
                }

                const usecaseSwitchDiv = $('<div class="form-check form-switch">');
                const usecaseSwitchInput = $(`<input class="form-check-input" type="checkbox" role="switch" id="use-case-switch">`);
                const usecaseSwitchLabel = $(`<label class="form-check-label" for="use-case-switch">`).text('Use Case');
                usecaseSwitchInput.change(function () {
                    const checked = $(this).prop('checked');
                    if (checked == true) {
                        usecaseDiv.show();
                    } else {
                        usecaseDiv.hide();
                    }
                });
                usecaseSwitchDiv.append(usecaseSwitchInput);
                usecaseSwitchDiv.append(usecaseSwitchLabel);

                const meaningSwitchDiv = $('<div class="form-check form-switch">');
                const meaningSwitchInput = $(`<input class="form-check-input" type="checkbox" role="switch" id="meaning-switch">`);
                const meaningSwitchLabel = $(`<label class="form-check-label" for="meaning-switch">`).text('Meaning');
                meaningSwitchInput.change(function () {
                    const checked = $(this).prop('checked');
                    if (checked == true) {
                        meaningDiv.show();
                    } else {
                        meaningDiv.hide();
                    }
                });
                meaningSwitchDiv.append(meaningSwitchInput);
                meaningSwitchDiv.append(meaningSwitchLabel);

                switchGroupDiv.append(usecaseSwitchDiv);
                switchGroupDiv.append(meaningSwitchDiv);

                meaningBodyDiv.append(progressDiv);
                meaningBodyDiv.append(wordDiv);
                meaningBodyDiv.append(switchGroupDiv);
                meaningBodyDiv.append(usecaseDiv);
                meaningBodyDiv.append(meaningDiv);

                reviewBody.append(meaningBodyDiv);
                reviewBody.append(btn);
            }
        }

        $(document).ready(function () {
            $.ajax({
                url: `/{{ passport }}/fetch-review-record`,
                type: 'GET',
                success: fecthCallback,
                error: httpErrorFunc,
            });

            window.addEventListener('keydown', function (e) {
                switch (e.keyCode) {
                    case 32: // 空格键
                        if (videoPlayer.paused()) {
                            videoPlayer.play();
                        } else {
                            videoPlayer.pause();
                        }
                        e.preventDefault();
                        break;
                }
            }, true);
            navigator.mediaSession.setActionHandler('play', function () {
                videoPlayer.play();
            });
            navigator.mediaSession.setActionHandler('pause', function () {
                videoPlayer.pause();
            });
        });
    </script>
</body>